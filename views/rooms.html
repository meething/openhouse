<!DOCTYPE html>
<html lang="en" dir="ltr">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=yes" />
    <title>Openhouse</title>
    <script src="https://cdn.jsdelivr.net/npm/ejs@3.1.6/ejs.min.js"></script>
    <script src="/js/rooms.js" defer></script>
    <link href="/css/style.css" rel="stylesheet">
    <script
      async
      src="//cdn.jsdelivr.net/npm/@fingerprintjs/fingerprintjs@3/dist/fp.min.js"
      onload="initFingerprintJS()"
    ></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/gun.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/open.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/gun/lib/path.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function(event) {
        var unique;
        function initFingerprintJS() {
          FingerprintJS.load().then(fp => {
            // The FingerprintJS agent is ready.
            // Get a visitor identifier when you'd like to.
            fp.get().then(result => {
              // This is the visitor identifier:
              unique = result.visitorId;
              console.log(visitorId);
            });
          });
        }
        console.log('room browser bootstrap')
        // Shared GUN scope for ROOM management only (no signaling here!)
        var gun = Gun({ peers: ["https://gundb-multiserver.glitch.me/openhouse"] });
        // Helper
        function clean(obj) {
          for (var propName in obj) {
            if (obj[propName] === null || obj[propName] === undefined || propName == "_" ) {
              delete obj[propName];
            }
          }
          return obj
        }
      
        // Raw gunRooms GUN
        var gunRooms;
        window.gunRooms = gun.get('rooms');
        window.gunRooms.open(function(obj){
            gunRooms = clean(obj);
            var html = ejs.render('<% for (const [room, id] of Object.entries(gunRooms)){ %>'
                                  +' <%if (id != null && id.title ) { %>'
                                  +' <button onClick="joinGunRoom(event)" class="w-full px-6 py-4 mb-2 bg-gray-200 hover:bg-gray-300 rounded-md font-medium" name="<%= room %>">'
                                  +'   <%= id.title %> (<%= room %>)'
                                  +' </button>'
                                  +' <% } %>'
                                  +'<% } %>', {gunRooms: gunRooms });
            // Vanilla JS:
            document.getElementById('output').innerHTML = html;  
        });
    });
    </script>

  </head>
  <body>
    <div id="bins">
    </div>
    <div class="max-w-4xl min-h-screen box-border px-10 py-5 mx-auto my-0">
      <h1 style="display: inline;" class="text-5xl my-10 " >openhøüse</h1>
      <button onclick="startRoom()" class="bg-green-500 hover:bg-green-600 text-white font-bold py-4 px-6 mt-4 mb-12 w-full rounded-full">+ Start a Room</button>
     
      <!-- experimental block -->
      <div id="output"></div>
      <script>
        
      </script>
      
    </div>
  </body>
</html>
